<!-- ΥΠΕΡΤΑΤΗ ΒΕΛΤΙΣΤΟΠΟΙΗΜΕΝΗ ΕΝΙΑΙΑ ΦΟΡΜΑ EUROPcar (Damage & Pickup) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
  .preview-img { max-height: 120px; margin: 5px; border-radius: 10px; border: 1px solid #ccc; }
</style>
<script>
  const translations = {
    el: {
      pickupTab: 'Φόρμα Παραλαβής',
      damageTab: 'Αναφορά Ζημιάς',
      langToggle: 'Αλλαγή σε Αγγλικά',
      irn: 'Αριθμός IRN*', email: 'Email (προαιρετικό)', plate: 'Πινακίδα', location: 'Τοποθεσία', date: 'Ημερομηνία', km: 'Χιλιόμετρα',
      incidentDate: 'Ημερομηνία Ζημιάς', description: 'Περιγραφή Ζημιάς', files: 'Φωτογραφίες*', submit: 'Αποστολή', sending: 'Αποστολή...', success: '✔️ Επιτυχία! Δείτε:', error: '❌ Σφάλμα'
    },
    en: {
      pickupTab: 'Pickup Form',
      damageTab: 'Damage Report',
      langToggle: 'Switch to Greek',
      irn: 'IRN Number*', email: 'Email (optional)', plate: 'Plate Number', location: 'Location', date: 'Date', km: 'Kilometers',
      incidentDate: 'Damage Date', description: 'Damage Description', files: 'Photos*', submit: 'Submit', sending: 'Sending...', success: '✔️ Success! View:', error: '❌ Error'
    }
  };
  let currentLang = 'el';

  function toggleLang() {
    currentLang = currentLang === 'el' ? 'en' : 'el';
    renderForm(currentForm);
  }

  let currentForm = 'pickup';
  function renderForm(form) {
    currentForm = form;
    const t = translations[currentLang];
    document.getElementById('formTitle').innerText = form === 'pickup' ? t.pickupTab : t.damageTab;
    document.getElementById('langBtn').innerText = t.langToggle;

    const commonFields = `
      <label class="form-label">${t.irn}</label>
      <input class="form-control mb-2" id="irn" required>
      <label class="form-label">${t.email}</label>
      <input type="email" class="form-control mb-2" id="email">
      <label class="form-label">${t.plate}</label>
      <input class="form-control mb-2" id="plate">
      <label class="form-label">${t.location}</label>
      <input class="form-control mb-2" id="location">
    `;

    let specific = '';
    if (form === 'pickup') {
      specific = `
        <label class="form-label">${t.date}</label>
        <input type="date" class="form-control mb-2" id="pickupDate">
        <label class="form-label">${t.km}</label>
        <input type="number" class="form-control mb-2" id="km">
      `;
    } else {
      specific = `
        <label class="form-label">${t.incidentDate}</label>
        <input type="date" class="form-control mb-2" id="damageDate">
        <label class="form-label">${t.description}</label>
        <textarea class="form-control mb-2" id="description"></textarea>
      `;
    }

    document.getElementById('formArea').innerHTML = `
      <form onsubmit="event.preventDefault(); handleSubmit()">
        ${commonFields + specific}
        <label class="form-label">${t.files}</label>
        <input type="file" class="form-control mb-2" id="files" multiple accept="image/*" required>
        <div id="preview" class="d-flex flex-wrap mb-2"></div>
        <div class="progress mb-2"><div id="progressBar" class="progress-bar" style="width:0%">0%</div></div>
        <button type="submit" class="btn btn-primary w-100">${t.submit}</button>
      </form>
    `;
    document.getElementById('status').innerHTML = '';
  }

  function handleSubmit() {
    const t = translations[currentLang];
    const irn = document.getElementById('irn').value.trim();
    const email = document.getElementById('email').value.trim();
    const plate = document.getElementById('plate').value.trim();
    const location = document.getElementById('location').value.trim();
    const files = document.getElementById('files').files;
    if (!irn || files.length === 0) { alert(t.error); return; }

    const readers = [...files].map((file, i) => new Promise(resolve => {
      const r = new FileReader();
      r.onload = e => resolve({ name: file.name, data: e.target.result });
      r.readAsDataURL(file);
    }));

    document.getElementById('progressBar').style.width = '10%';
    document.getElementById('progressBar').innerText = '10%';
    document.getElementById('status').innerHTML = t.sending;

    Promise.all(readers).then(fileData => {
      const payload = {
        type: currentForm,
        irn,
        email,
        plate,
        location,
        language: currentLang,
        files: fileData,
        pickupDate: document.getElementById('pickupDate')?.value,
        km: document.getElementById('km')?.value,
        damageDate: document.getElementById('damageDate')?.value,
        description: document.getElementById('description')?.value
      };
      google.script.run.withSuccessHandler(res => {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressBar').innerText = '100%';
        document.getElementById('status').innerHTML = `${t.success} <a href="${res.folderUrl}" target="_blank">${res.folderUrl}</a>`;
      }).withFailureHandler(err => {
        document.getElementById('status').innerHTML = `${t.error}: ${err.message}`;
      }).submitForm(payload);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('change', e => {
      if (e.target.id === 'files') {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        [...e.target.files].forEach(file => {
          const r = new FileReader();
          r.onload = ev => {
            const img = document.createElement('img');
            img.src = ev.target.result;
            img.className = 'preview-img';
            preview.appendChild(img);
          };
          r.readAsDataURL(file);
        });
      }
    });
    renderForm('pickup');
  });
</script>
<div class="container mt-4">
  <div class="d-flex justify-content-between mb-2">
    <div>
      <button class="btn btn-outline-primary me-2" onclick="renderForm('pickup')">🚗 <span id="pickupTab">Φόρμα Παραλαβής</span></button>
      <button class="btn btn-outline-danger" onclick="renderForm('damage')">💥 <span id="damageTab">Αναφορά Ζημιάς</span></button>
    </div>
    <button class="btn btn-secondary" id="langBtn" onclick="toggleLang()">Αλλαγή σε Αγγλικά</button>
  </div>
  <h3 id="formTitle">Φόρμα</h3>
  <div id="formArea"></div>
  <div id="status" class="mt-3"></div>
</div>
